name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'main'
      - 'develop'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm -r install --frozen-lockfile

      - name: Detect changed workspaces
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'packages/core/**'
            docs:
              - 'apps/docs/**'
            playground:
              - 'apps/playground/**'

      - name: Lint (all workspaces)
        run: pnpm -w lint

      - name: Test (core)
        if: steps.changes.outputs.core == 'true'
        run: pnpm -C packages/core test

      - name: Build packages/core (timed)
        id: build_core
        if: steps.changes.outputs.core == 'true' || steps.changes.outputs.docs == 'true' || steps.changes.outputs.playground == 'true'
        run: |
          start=$(date +%s)
          set +e
          pnpm -C packages/core build
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

      - name: Build apps/docs (timed)
        id: build_docs
        if: steps.changes.outputs.docs == 'true' || steps.changes.outputs.core == 'true'
        run: |
          start=$(date +%s)
          set +e
          pnpm -C apps/docs build
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

      - name: Build apps/playground (timed)
        id: build_playground
        if: steps.changes.outputs.playground == 'true' || steps.changes.outputs.core == 'true'
        run: |
          start=$(date +%s)
          set +e
          pnpm -C apps/playground build
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

      - name: Comment build results on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mkLine = (name, outcome, secs) => {
              const pretty = secs ? ` (${Math.floor(secs/60)}m ${secs%60}s)` : '';
              return outcome === 'success'
                ? `âœ… ${name} ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ğŸ‰${pretty}`
                : outcome === 'skipped'
                ? `âšª ${name} ë¹Œë“œ ìŠ¤í‚µë¨${pretty}`
                : `âŒ ${name} ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ğŸ˜­${pretty}`;
            };
            const coreOutcome = '${{ steps.build_core.outcome || 'skipped' }}';
            const docsOutcome = '${{ steps.build_docs.outcome || 'skipped' }}';
            const playgroundOutcome = '${{ steps.build_playground.outcome || 'skipped' }}';
            const coreSecs = Number('${{ steps.build_core.outputs.duration || '' }}' || 0);
            const docsSecs = Number('${{ steps.build_docs.outputs.duration || '' }}' || 0);
            const playgroundSecs = Number('${{ steps.build_playground.outputs.duration || '' }}' || 0);
            const lines = [
              mkLine('packages/core', coreOutcome, coreSecs),
              mkLine('apps/playground', playgroundOutcome, playgroundSecs),
              mkLine('apps/docs', docsOutcome, docsSecs),
            ];
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: lines.join('\n\n')
            });

      - name: Fail if any build failed
        if: always()
        run: |
          if [ "${{ steps.build_core.outcome }}" = "failure" ] || \
             [ "${{ steps.build_playground.outcome }}" = "failure" ] || \
             [ "${{ steps.build_docs.outcome }}" = "failure" ]; then
            exit 1
          fi
