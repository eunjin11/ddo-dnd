name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'main'
      - 'develop'

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint (all workspaces)
        run: pnpm -w lint

      - name: Test (core)
        run: pnpm test

  build-core:
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      duration: ${{ steps.build.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build packages/core (timed)
        id: build
        run: |
          start=$(date +%s)
          pnpm -C packages/core build || true
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

  build-playground:
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      duration: ${{ steps.build.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build apps/playground (timed)
        id: build
        run: |
          start=$(date +%s)
          pnpm -C apps/playground build || true
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

  build-docs:
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      duration: ${{ steps.build.outputs.duration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build apps/docs (timed)
        id: build
        run: |
          start=$(date +%s)
          pnpm -C apps/docs build || true
          status=$?
          end=$(date +%s)
          echo "duration=$((end-start))" >> "$GITHUB_OUTPUT"
          exit $status

  report:
    runs-on: ubuntu-latest
    needs: [build-core, build-playground, build-docs]
    permissions:
      contents: read
      issues: write
      pull-requests: write
    if: always()
    steps:
      - name: Comment build results on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const mkLine = (name, result, secs) => {
              const pretty = secs ? ` (${Math.floor(secs/60)}m ${secs%60}s)` : '';
              return result === 'success'
                ? `âœ… ${name} ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ğŸ‰${pretty}`
                : result === 'skipped'
                ? `âšª ${name} ë¹Œë“œ ìŠ¤í‚µë¨${pretty}`
                : `âŒ ${name} ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ğŸ˜­${pretty}`;
            };
            const core = {
              result: '${{ needs.build-core.result }}',
              secs: Number('${{ needs.build-core.outputs.duration }}' || 0)
            };
            const playground = {
              result: '${{ needs.build-playground.result }}',
              secs: Number('${{ needs.build-playground.outputs.duration }}' || 0)
            };
            const docs = {
              result: '${{ needs.build-docs.result }}',
              secs: Number('${{ needs.build-docs.outputs.duration }}' || 0)
            };
            const lines = [
              mkLine('packages/core', core.result, core.secs),
              mkLine('apps/playground', playground.result, playground.secs),
              mkLine('apps/docs', docs.result, docs.secs),
            ];
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: lines.join('\n\n')
            });

      - name: Fail if any build failed
        run: |
          if [ "${{ needs.build-core.result }}" = "failure" ] || \
             [ "${{ needs.build-playground.result }}" = "failure" ] || \
             [ "${{ needs.build-docs.result }}" = "failure" ]; then
            exit 1
          fi
